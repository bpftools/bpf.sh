<!DOCTYPE html>
<!--
==============================================================================
           "GitHub HTML5 Pandoc Template" v2.1 — by Tristano Ajmone           
==============================================================================
Copyright © Tristano Ajmone, 2017, MIT License (MIT). Project's home:

- https://github.com/tajmone/pandoc-goodies

The CSS in this template reuses source code taken from the following projects:

- GitHub Markdown CSS: Copyright © Sindre Sorhus, MIT License (MIT):
  https://github.com/sindresorhus/github-markdown-css

- Primer CSS: Copyright © 2016-2017 GitHub Inc., MIT License (MIT):
  http://primercss.io/

~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The MIT License 

Copyright (c) Tristano Ajmone, 2017 (github.com/tajmone/pandoc-goodies)
Copyright (c) Sindre Sorhus <sindresorhus@gmail.com> (sindresorhus.com)
Copyright (c) 2017 GitHub Inc.

"GitHub Pandoc HTML5 Template" is Copyright (c) Tristano Ajmone, 2017, released
under the MIT License (MIT); it contains readaptations of substantial portions
of the following third party softwares:

(1) "GitHub Markdown CSS", Copyright (c) Sindre Sorhus, MIT License (MIT).
(2) "Primer CSS", Copyright (c) 2016 GitHub Inc., MIT License (MIT).

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
==============================================================================-->
<html>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Dale Hamel" />
  <title>Production Breakpoints</title>
  <style type="text/css">
.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";font-size:16px;line-height:1.5;word-wrap:break-word;box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto;padding:45px}.markdown-body a{color:#0366d6;background-color:transparent;text-decoration:none;-webkit-text-decoration-skip:objects}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body a:hover{text-decoration:underline}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body strong{font-weight:600}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em;margin:.67em 0;padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{padding-bottom:.3em;font-size:1.5em;border-bottom:1px solid #eaecef}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body img{border-style:none}.markdown-body svg:not(:root){overflow:hidden}.markdown-body hr{box-sizing:content-box;height:.25em;margin:24px 0;padding:0;overflow:hidden;background-color:#e1e4e8;border:0}.markdown-body hr::before{display:table;content:""}.markdown-body hr::after{display:table;clear:both;content:""}.markdown-body input{margin:0;overflow:visible;font:inherit;font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body li>p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dd{margin-left:0}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body code{font-family:SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace}.markdown-body pre{font:12px SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace;word-wrap:normal}.markdown-body blockquote,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote>:first-child{margin-top:0}.markdown-body blockquote>:last-child{margin-bottom:0}.markdown-body table{display:block;width:100%;overflow:auto;border-spacing:0;border-collapse:collapse}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:content-box;background-color:#fff}.markdown-body code{padding:.2em 0;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code::after,.markdown-body code::before{letter-spacing:-.2em;content:"\00a0"}.markdown-body pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:0 0;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}.markdown-body pre code::after,.markdown-body pre code::before{content:normal}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body kbd{box-shadow:inset 0 -1px 0 #959da5;display:inline-block;padding:3px 5px;font:11px/10px SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace;color:#444d56;vertical-align:middle;background-color:#fcfcfc;border:1px solid #c6cbd1;border-bottom-color:#959da5;border-radius:3px;box-shadow:inset 0 -1px 0 #959da5}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}.markdown-body::before{display:table;content:""}.markdown-body::after{display:table;clear:both;content:""}.markdown-body>:first-child{margin-top:0!important}.markdown-body>:last-child{margin-bottom:0!important}.Alert,.Error,.Note,.Success,.Warning{padding:11px;margin-bottom:24px;border-style:solid;border-width:1px;border-radius:4px}.Alert p,.Error p,.Note p,.Success p,.Warning p{margin-top:0}.Alert p:last-child,.Error p:last-child,.Note p:last-child,.Success p:last-child,.Warning p:last-child{margin-bottom:0}.Alert{color:#246;background-color:#e2eef9;border-color:#bac6d3}.Warning{color:#4c4a42;background-color:#fff9ea;border-color:#dfd8c2}.Error{color:#911;background-color:#fcdede;border-color:#d2b2b2}.Success{color:#22662c;background-color:#e2f9e5;border-color:#bad3be}.Note{color:#2f363d;background-color:#f6f8fa;border-color:#d5d8da}.Alert h1,.Alert h2,.Alert h3,.Alert h4,.Alert h5,.Alert h6{color:#246;margin-bottom:0}.Warning h1,.Warning h2,.Warning h3,.Warning h4,.Warning h5,.Warning h6{color:#4c4a42;margin-bottom:0}.Error h1,.Error h2,.Error h3,.Error h4,.Error h5,.Error h6{color:#911;margin-bottom:0}.Success h1,.Success h2,.Success h3,.Success h4,.Success h5,.Success h6{color:#22662c;margin-bottom:0}.Note h1,.Note h2,.Note h3,.Note h4,.Note h5,.Note h6{color:#2f363d;margin-bottom:0}.Alert h1:first-child,.Alert h2:first-child,.Alert h3:first-child,.Alert h4:first-child,.Alert h5:first-child,.Alert h6:first-child,.Error h1:first-child,.Error h2:first-child,.Error h3:first-child,.Error h4:first-child,.Error h5:first-child,.Error h6:first-child,.Note h1:first-child,.Note h2:first-child,.Note h3:first-child,.Note h4:first-child,.Note h5:first-child,.Note h6:first-child,.Success h1:first-child,.Success h2:first-child,.Success h3:first-child,.Success h4:first-child,.Success h5:first-child,.Success h6:first-child,.Warning h1:first-child,.Warning h2:first-child,.Warning h3:first-child,.Warning h4:first-child,.Warning h5:first-child,.Warning h6:first-child{margin-top:0}h1.title,p.subtitle{text-align:center}h1.title.followed-by-subtitle{margin-bottom:0}p.subtitle{font-size:1.5em;font-weight:600;line-height:1.25;margin-top:0;margin-bottom:16px;padding-bottom:.3em}div.line-block{white-space:pre-line}
  </style>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #2a211c;
    color: #bdae9d;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #bdae9d;  padding-left: 4px; }
div.sourceCode
  { color: #bdae9d; background-color: #2a211c; }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ffff00; } /* Alert */
code span.an { color: #0066ff; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #44aa43; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #43a8ed; font-weight: bold; } /* ControlFlow */
code span.ch { color: #049b0a; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #0066ff; font-weight: bold; font-style: italic; } /* Comment */
code span.do { color: #0066ff; font-style: italic; } /* Documentation */
code span.dt { text-decoration: underline; } /* DataType */
code span.dv { color: #44aa43; } /* DecVal */
code span.er { color: #ffff00; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #44aa43; } /* Float */
code span.fu { color: #ff9358; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #0066ff; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #43a8ed; font-weight: bold; } /* Keyword */
code span.op { } /* Operator */
code span.pp { font-weight: bold; } /* Preprocessor */
code span.sc { color: #049b0a; } /* SpecialChar */
code span.ss { color: #049b0a; } /* SpecialString */
code span.st { color: #049b0a; } /* String */
code span.va { } /* Variable */
code span.vs { color: #049b0a; } /* VerbatimString */
code span.wa { color: #ffff00; font-weight: bold; } /* Warning */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<article class="markdown-body">
<header>
<h1 class="title">Production Breakpoints</h1>
<p class="author">Dale Hamel</p>
<p class="date">07/21/19 08:24:13 PM UTC</p>
</header>
<hr>
<nav id="TOC">
<h1 class="toc-title">Contents</h1>
<ul>
<li><a href="#ruby-production-breakpoints">Ruby Production Breakpoints</a></li>
<li><a href="#how-this-works">How this works</a></li>
<li><a href="#injecting-breakpoints">Injecting breakpoints</a></li>
<li><a href="#specifying-breakpoints">Specifying breakpoints</a></li>
<li><a href="#built-in-breakpoints">Built-in breakpoints</a><ul>
<li><a href="#latency">Latency</a></li>
<li><a href="#locals">Locals</a></li>
<li><a href="#inspect">Inspect</a></li>
</ul></li>
<li><a href="#internals">Internals</a><ul>
<li><a href="#loading-breakpoints">Loading breakpoints</a></li>
<li><a href="#ruby-override-technique">Ruby Override technique</a></li>
<li><a href="#dynamically-redefined-method">Dynamically redefined Method</a></li>
</ul></li>
</ul>
</nav>
<hr>
<h1 id="ruby-production-breakpoints">Ruby Production Breakpoints</h1>
<h1 id="how-this-works">How this works</h1>
<p>Ruby “production breakpoints” rewrite the source code of a method with the targeted lines to include a wrapper around those lines.</p>
<p>The method is redefined by prepending a module with the new definition to the parent of the original method, overriding it. To undo this, the module can be ‘unprepended’ restoring the original behavior.</p>
<p>When a breakpoint line is executed, we can use the Linux Kernel to interrupt our application and retrieve some data we’ve prepared for it.</p>
<p>Unless a breakpoint is both enabled and attached to by a debugger, it shouldn’t change execution</p>
<h1 id="injecting-breakpoints">Injecting breakpoints</h1>
<p>To do this, we will need to actually rewrite Ruby functions to inject our tracing code around the selected line or lines. Ruby 2.6 + has built-in AST parsing, so we can use this to determine what needs to be redefined, in order to add our tracer.</p>
<p>The AST parsing will show us the scope of the lines that the user would like to trace, and will load the method scope of the lines, in order to inject the tracing support. This modified ruby code string can then be evaluated in the scope of an anonymous module, which is prepended to the parent of the method that has been redefined.</p>
<p>This will put it at the tip of the chain, and override the original copy of this method. Upon unprepending the module, the original definition should be what is evaluated by Ruby’s runtime Polymorphic method message mapping.</p>
<h1 id="specifying-breakpoints">Specifying breakpoints</h1>
<p>A global config value:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb1-1" title="1"><span class="dt">ProductionBreakpoints</span>.config_file</a></code></pre></div>
<p>Can be set to specify the path to a JSON config, indicating the breakpoints that are to be installed:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode json"><code class="sourceCode json"><a class="sourceLine" id="cb2-1" title="1"><span class="fu">{</span></a>
<a class="sourceLine" id="cb2-2" title="2">  <span class="dt">&quot;breakpoints&quot;</span><span class="fu">:</span> <span class="ot">[</span></a>
<a class="sourceLine" id="cb2-3" title="3">    <span class="fu">{</span></a>
<a class="sourceLine" id="cb2-4" title="4">      <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="st">&quot;inspect&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb2-5" title="5">      <span class="dt">&quot;source_file&quot;</span><span class="fu">:</span> <span class="st">&quot;test/ruby_sources/config_target.rb&quot;</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb2-6" title="6">      <span class="dt">&quot;start_line&quot;</span><span class="fu">:</span> <span class="dv">7</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb2-7" title="7">      <span class="dt">&quot;end_line&quot;</span><span class="fu">:</span> <span class="dv">9</span><span class="fu">,</span></a>
<a class="sourceLine" id="cb2-8" title="8">      <span class="dt">&quot;trace_id&quot;</span><span class="fu">:</span> <span class="st">&quot;config_file_test&quot;</span></a>
<a class="sourceLine" id="cb2-9" title="9">    <span class="fu">}</span></a>
<a class="sourceLine" id="cb2-10" title="10">  <span class="ot">]</span></a>
<a class="sourceLine" id="cb2-11" title="11"><span class="fu">}</span></a></code></pre></div>
<p>These values indicate:</p>
<ul>
<li><code>type</code>: the built-in breakpoint handler to run when the specified breakpoint is hit in production.</li>
<li><code>source_file</code>: the source repository-root relative path to the source file to install a breakpoint within. (note, the path of this source folder relative to the host / mount namespace is to be handled elsewhere by the caller that initiates tracing via this gem)</li>
<li><code>start_line</code>: The first line which should be evaluated from the context of the breakpoint.</li>
<li><code>end_line</code>: The last line which should be evaluated in the context of the breakpoint</li>
<li><code>trace_id</code>: A key to group the output of executing the breakpoint, and filter results associated with a particular breakpoint invocation</li>
</ul>
<p>Many breakpoints can be specified. Breakpoints that apply to the same file are added and removed simultaneously. Breakpoints that are applied but not specified in the config file will be removed if the config file is reloaded.</p>
<h1 id="built-in-breakpoints">Built-in breakpoints</h1>
<h2 id="latency">Latency</h2>
<p>Output: Integer, nanoseconds elapsed</p>
<p>The latency breakpoint provides the elapsed time from a monotonic source, for the duration of the breakpoint handler.</p>
<p>This shows the time required to execute the code between the start and end lines, within a given method.</p>
<p>Handler definition:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb3-1" title="1">      <span class="kw">def</span> handle(caller_binding, &amp;block)</a>
<a class="sourceLine" id="cb3-2" title="2">        <span class="kw">return</span> <span class="dv">super</span>(caller_binding, &amp;block) <span class="kw">unless</span> <span class="ot">@tracepoint</span>.enabled?</a>
<a class="sourceLine" id="cb3-3" title="3">        start_time = <span class="dt">StaticTracing</span>.nsec</a>
<a class="sourceLine" id="cb3-4" title="4">        val = <span class="dv">super</span>(caller_binding, &amp;block)</a>
<a class="sourceLine" id="cb3-5" title="5">        duration = <span class="dt">StaticTracing</span>.nsec - start_time</a>
<a class="sourceLine" id="cb3-6" title="6">        <span class="ot">@tracepoint</span>.fire(duration)</a>
<a class="sourceLine" id="cb3-7" title="7">        <span class="kw">return</span> val</a>
<a class="sourceLine" id="cb3-8" title="8">      <span class="kw">end</span></a></code></pre></div>
<h2 id="locals">Locals</h2>
<p>Output: String, key,value via ruby inspect</p>
<p>The ‘locals’ breakpoint shows the value of all locals.</p>
<p>NOTE: due to limitations in eBPF, there is a maximum serializable string size. Very complex objects cannot be efficiently serialized and inspected.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb4-1" title="1">      <span class="kw">def</span> handle(caller_binding, &amp;block)</a>
<a class="sourceLine" id="cb4-2" title="2">        <span class="kw">return</span> <span class="dv">super</span>(caller_binding, &amp;block) <span class="kw">unless</span> <span class="ot">@tracepoint</span>.enabled?</a>
<a class="sourceLine" id="cb4-3" title="3">        val = <span class="dv">super</span>(caller_binding, &amp;block)</a>
<a class="sourceLine" id="cb4-4" title="4">        locals = caller_binding.local_variables</a>
<a class="sourceLine" id="cb4-5" title="5">        locals.delete(<span class="st">:local_bind</span>) <span class="co"># we define this, so we&#39;ll get rid of it</span></a>
<a class="sourceLine" id="cb4-6" title="6">        vals = locals.map { |v| [v, caller_binding.local_variable_get(v) ]}.to_h</a>
<a class="sourceLine" id="cb4-7" title="7">        <span class="ot">@tracepoint</span>.fire(vals.inspect)</a>
<a class="sourceLine" id="cb4-8" title="8">        <span class="kw">return</span> val</a>
<a class="sourceLine" id="cb4-9" title="9">      <span class="kw">end</span></a></code></pre></div>
<h2 id="inspect">Inspect</h2>
<p>Output: String, value via ruby inspect</p>
<p>The ‘inspect’ command shows the inspected value of whatever the last expression evaluated to within the breakpoint handler block.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb5-1" title="1">      <span class="kw">def</span> handle(caller_binding, &amp;block)</a>
<a class="sourceLine" id="cb5-2" title="2">        <span class="kw">return</span> <span class="dv">super</span>(caller_binding, &amp;block) <span class="kw">unless</span> <span class="ot">@tracepoint</span>.enabled?</a>
<a class="sourceLine" id="cb5-3" title="3">        val = <span class="dv">super</span>(caller_binding, &amp;block)</a>
<a class="sourceLine" id="cb5-4" title="4">        <span class="ot">@tracepoint</span>.fire(val.inspect)</a>
<a class="sourceLine" id="cb5-5" title="5">        <span class="kw">return</span> val</a>
<a class="sourceLine" id="cb5-6" title="6">      <span class="kw">end</span></a></code></pre></div>
<h1 id="internals">Internals</h1>
<h2 id="loading-breakpoints">Loading breakpoints</h2>
<p>This gem leverages the ruby-static-tracing gem which provides the ‘secret sauce’ that allows for plucking this data out of a ruby process, using the kernel’s handling of the intel x86 “Breakpoint” int3 instruction.</p>
<p>For each source file, a ‘shadow’ ELF stub is associated with it, and can be easily found by inspecting the processes open file handles.</p>
<p>After all breakpoints have been specified for a file, the ELF stub can be generated and loaded. To update or remove breakpoints, this ELF stub needs to be re-loaded, which requires the breakpoints to be disabled first. To avoid this, the scope could be changed to be something other than file, but file is believed to be nice and easily discoverable for now.</p>
<p>The tracing code will noop, until a tracer is actually attached to it, and should have minimal performance implications.</p>
<h2 id="ruby-override-technique">Ruby Override technique</h2>
<p>The ‘unmixer’ gem hooks into the ruby internal header API, and provides a back-door into the RubyVM source code to ‘unappend’ classes or modules from the global hierarchy.</p>
<p>An anonymous module is created, with the modified source code containing our breakpoint handler.</p>
<p>To enable the breakpoint code, this module is prepended to the original method’s parent. To undo this, the module is simply ‘unprepended’, a feature unmixer uses to tap into Ruby’s ancestry hierarchy via a native extension.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb6-1" title="1">      <span class="kw">def</span> install</a>
<a class="sourceLine" id="cb6-2" title="2">        <span class="ot">@injector_module</span> = build_redefined_definition_module(<span class="ot">@node</span>)</a>
<a class="sourceLine" id="cb6-3" title="3">        <span class="ot">@ns</span>.prepend(<span class="ot">@injector_module</span>)</a>
<a class="sourceLine" id="cb6-4" title="4">      <span class="kw">end</span></a>
<a class="sourceLine" id="cb6-5" title="5"></a>
<a class="sourceLine" id="cb6-6" title="6">      <span class="co"># </span><span class="al">FIXME</span><span class="co"> saftey if already uninstalled</span></a>
<a class="sourceLine" id="cb6-7" title="7">      <span class="kw">def</span> uninstall</a>
<a class="sourceLine" id="cb6-8" title="8">        <span class="ot">@ns</span>.instance_eval{ unprepend(<span class="ot">@injector_module</span>) }</a>
<a class="sourceLine" id="cb6-9" title="9">        <span class="ot">@injector_module</span> = <span class="dv">nil</span></a>
<a class="sourceLine" id="cb6-10" title="10">      <span class="kw">end</span></a></code></pre></div>
<h2 id="dynamically-redefined-method">Dynamically redefined Method</h2>
<p>We define a ‘handler’ and a ‘finisher’ block for each breakpoint we attach.</p>
<p>Presently, we don’t support attaching multiple breakpoints within the same function, but we could do so if we applied this as a chain of handers followed by a finalizer, but that will be a feature for later. Some locking should exist to ensure the same method is not overriden multiple times until this is done.</p>
<p>These hooks into our breakpoint API are injected into the method source from the locations we used the ruby AST libraries to parse:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb7-1" title="1">      <span class="kw">def</span> build_redefined_definition_module(node)</a>
<a class="sourceLine" id="cb7-2" title="2"></a>
<a class="sourceLine" id="cb7-3" title="3">        <span class="co"># This is the metaprogramming to inject our breakpoint handler around the original source code</span></a>
<a class="sourceLine" id="cb7-4" title="4">        handler = <span class="st">&quot;local_bind=binding; ProductionBreakpoints.installed_breakpoints[:</span><span class="ot">#{@trace_id}</span><span class="st">].handle(local_bind)&quot;</span></a>
<a class="sourceLine" id="cb7-5" title="5"></a>
<a class="sourceLine" id="cb7-6" title="6">        <span class="co"># This is needed to keep the execution of the remaining lines of the method within the same binding</span></a>
<a class="sourceLine" id="cb7-7" title="7">        finisher = <span class="st">&quot;ProductionBreakpoints.installed_breakpoints[:</span><span class="ot">#{@trace_id}</span><span class="st">].finish(local_bind)&quot;</span></a>
<a class="sourceLine" id="cb7-8" title="8"></a>
<a class="sourceLine" id="cb7-9" title="9">        <span class="co"># This injects our handler and finisher blocks into the original source code, treating the code</span></a>
<a class="sourceLine" id="cb7-10" title="10">        <span class="co"># in between as string literals to be evaluated</span></a>
<a class="sourceLine" id="cb7-11" title="11">        injected = <span class="ot">@parser</span>.inject_metaprogramming_handlers(handler, finisher,</a>
<a class="sourceLine" id="cb7-12" title="12">                                             node.first_lineno, node.last_lineno, <span class="ot">@start_line</span>, <span class="ot">@end_line</span>)</a>
<a class="sourceLine" id="cb7-13" title="13">        <span class="co">#ProductionBreakpoints.logger.debug(injected)</span></a>
<a class="sourceLine" id="cb7-14" title="14">        <span class="dt">Module</span>.new { <span class="kw">module</span>_eval{ eval(injected); eval(<span class="st">&#39;def production_breakpoint_enabled?; true; end;&#39;</span>) } }</a>
<a class="sourceLine" id="cb7-15" title="15">      <span class="kw">end</span></a></code></pre></div>
<p>And the outcome looks lomething like this:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb8-1" title="1"><span class="co"># def some_method</span></a>
<a class="sourceLine" id="cb8-2" title="2"><span class="co"># local_bind=binding; ProductionBreakpoints.installed_breakpoints[:test_breakpoint_install].handle(local_bind) do</span></a>
<a class="sourceLine" id="cb8-3" title="3"><span class="co"># &lt;&lt;-EOS</span></a>
<a class="sourceLine" id="cb8-4" title="4"><span class="co">#       a = 1</span></a>
<a class="sourceLine" id="cb8-5" title="5"><span class="co">#       sleep 0.5</span></a>
<a class="sourceLine" id="cb8-6" title="6"><span class="co">#       b = a + 1</span></a>
<a class="sourceLine" id="cb8-7" title="7"><span class="co"># EOS</span></a>
<a class="sourceLine" id="cb8-8" title="8"><span class="co"># end</span></a>
<a class="sourceLine" id="cb8-9" title="9"><span class="co">#  ProductionBreakpoints.installed_breakpoints[:test_breakpoint_install].finish(local_bind) do</span></a>
<a class="sourceLine" id="cb8-10" title="10"><span class="co"># &lt;&lt;-EOS</span></a>
<a class="sourceLine" id="cb8-11" title="11"><span class="co"># EOS</span></a>
<a class="sourceLine" id="cb8-12" title="12"><span class="co"># end</span></a>
<a class="sourceLine" id="cb8-13" title="13"><span class="co">#     end</span></a></code></pre></div>
<p>This is called when the breakpoint is handled, in order to evaluate the whole method within the original, intended context:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb9-1" title="1">      <span class="co"># Allows for specific handling of the selected lines</span></a>
<a class="sourceLine" id="cb9-2" title="2">      <span class="kw">def</span> handle(caller_binding)</a>
<a class="sourceLine" id="cb9-3" title="3">        eval(<span class="kw">yield</span>, caller_binding)</a>
<a class="sourceLine" id="cb9-4" title="4">      <span class="kw">end</span></a>
<a class="sourceLine" id="cb9-5" title="5"></a>
<a class="sourceLine" id="cb9-6" title="6">      <span class="co"># Execute remaining lines of method in the same binding</span></a>
<a class="sourceLine" id="cb9-7" title="7">      <span class="kw">def</span> finish(caller_binding)</a>
<a class="sourceLine" id="cb9-8" title="8">        eval(<span class="kw">yield</span>, caller_binding)</a>
<a class="sourceLine" id="cb9-9" title="9">      <span class="kw">end</span></a></code></pre></div>
<p>This caller binding is taken at the point our handler starts, so it’s propagated from the untraced code within the method. We use it to evaluate the original source within the handler and finalizer, to ensure that the whole method is evaluated within the original context / binding that it was intended to. This should make the fact that there is a breakpoint installed transparent to the application.</p>
<p>The breakpoint handler code (see above) is only executed when the handler is attached, as they all contain an early return if the shadow “ELF” source doesn’t have a breakpoint installed, via the <code>enabled?</code> check.</p>
</article>
</body>
</html>
